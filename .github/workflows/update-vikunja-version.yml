name: Check for Vikunja Updates

# This workflow requires a Personal Access Token (PAT) to create pull requests.
# See instructions below on how to set up the PAT_TOKEN secret.

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get latest Vikunja version from Docker Hub
        id: vikunja
        run: |
          # Fetch available tags from Docker Hub
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/vikunja/vikunja/tags?page_size=100" | jq -r '.results[].name')
          
          # Filter to get only semantic version tags (e.g., 1.0.0, not "latest" or "unstable")
          # Find the highest version number
          LATEST_VERSION=$(echo "$TAGS" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
          
          echo "Latest Vikunja version on Docker Hub: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
      
      - name: Get current version from Dockerfile
        id: current
        run: |
          CURRENT_VERSION=$(grep "ARG VIKUNJA_VERSION=" vikunja_aio/Dockerfile | cut -d'=' -f2)
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
      
      - name: Compare versions
        id: compare
        run: |
          if [ "${{ steps.vikunja.outputs.latest_version }}" != "${{ steps.current.outputs.current_version }}" ]; then
            echo "Update needed!"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date!"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for existing PR/Issue
        if: steps.compare.outputs.needs_update == 'true'
        id: check_duplicate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const latestVersion = '${{ steps.vikunja.outputs.latest_version }}';
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:update-vikunja-${latestVersion}`
            });
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'vikunja-update'
            });
            
            const existingIssue = issues.find(i => i.title.includes(latestVersion));
            const duplicate = pulls.length > 0 || !!existingIssue;
            
            if (duplicate) {
              console.log(`Duplicate detected for version ${latestVersion}. Skip further actions.`);
            } else {
              console.log(`No existing PR or Issue found for version ${latestVersion}.`);
            }
            
            core.setOutput('duplicate_detected', duplicate.toString());

      - name: Update Dockerfile
        if: steps.compare.outputs.needs_update == 'true' && steps.check_duplicate.outputs.duplicate_detected != 'true'
        run: |
          sed -i "s/ARG VIKUNJA_VERSION=.*/ARG VIKUNJA_VERSION=${{ steps.vikunja.outputs.latest_version }}/" vikunja_aio/Dockerfile
      
      - name: Update addon version in config.yaml
        if: steps.compare.outputs.needs_update == 'true' && steps.check_duplicate.outputs.duplicate_detected != 'true'
        run: |
          # Set addon version to match Vikunja version
          NEW_ADDON_VERSION="${{ steps.vikunja.outputs.latest_version }}"
          echo "Setting addon version to: $NEW_ADDON_VERSION"
          sed -i "s/^version: \".*\"/version: \"$NEW_ADDON_VERSION\"/" vikunja_aio/config.yaml
      
      - name: Create Pull Request
        if: steps.compare.outputs.needs_update == 'true' && steps.check_duplicate.outputs.duplicate_detected != 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: update Vikunja to ${{ steps.vikunja.outputs.latest_version }}"
          title: "Update Vikunja to ${{ steps.vikunja.outputs.latest_version }}"
          body: |
            ## ðŸš€ Vikunja Update Available
            
            A new version of Vikunja has been released!
            
            **Changes:**
            - Vikunja version: `${{ steps.current.outputs.current_version }}` â†’ `${{ steps.vikunja.outputs.latest_version }}`
            - Addon version incremented automatically
            
            **Release Notes:**
            https://github.com/go-vikunja/vikunja/releases/tag/${{ steps.vikunja.outputs.latest_version }}
            
            ---
            *This PR was automatically created by the Vikunja version check workflow.*
          branch: update-vikunja-${{ steps.vikunja.outputs.latest_version }}
          delete-branch: true
          labels: |
            dependencies
            automated
      
      - name: Create GitHub Issue
        if: steps.compare.outputs.needs_update == 'true' && steps.check_duplicate.outputs.duplicate_detected != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”” New Vikunja Version Available: ${{ steps.vikunja.outputs.latest_version }}',
              body: `## ðŸš€ Vikunja Update Notification
              
              A new version of Vikunja has been detected and a Pull Request has been automatically created.
              
              **Version Update:**
              - Current: \`${{ steps.current.outputs.current_version }}\`
              - Latest: \`${{ steps.vikunja.outputs.latest_version }}\`
              
              **Actions Taken:**
              - âœ… Pull Request created: ${{ steps.create_pr.outputs.pull-request-url }}
              - âœ… Dockerfile updated
              - âœ… Addon version incremented
              
              **Next Steps:**
              1. Review the Pull Request
              2. Check the [Vikunja Release Notes](https://github.com/go-vikunja/vikunja/releases/tag/${{ steps.vikunja.outputs.latest_version }})
              3. Test the changes if needed
              4. Merge the PR when ready
              
              ---
              *This issue was automatically created by the version check workflow.*`,
              labels: ['notification', 'vikunja-update']
            })
      

      - name: Generate Summary
        if: steps.compare.outputs.needs_update == 'true' && steps.check_duplicate.outputs.duplicate_detected != 'true'
        run: |
          echo "## ðŸš€ Vikunja Update Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A new version of Vikunja has been released!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current Version | \`${{ steps.current.outputs.current_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | \`${{ steps.vikunja.outputs.latest_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Pull Request | ${{ steps.create_pr.outputs.pull-request-url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Notes | https://github.com/go-vikunja/vikunja/releases/tag/${{ steps.vikunja.outputs.latest_version }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Generate Summary (No Update)
        if: steps.compare.outputs.needs_update == 'false'
        run: |
          echo "## âœ… Vikunja is Up to Date" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Current version \`${{ steps.current.outputs.current_version }}\` is the latest version." >> $GITHUB_STEP_SUMMARY
